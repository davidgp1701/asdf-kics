#!/usr/bin/env bash

set -euo pipefail

# Based on: https://github.com/luizm/asdf-shellcheck/blob/master/bin/install

ASDF_INSTALL_TYPE=${ASDF_INSTALL_TYPE:-version  }

test -n "$ASDF_INSTALL_VERSION" || {
  echo 'Missing ASDF_INSTALL_VERSION'
  exit 1
}

test -n "$ASDF_INSTALL_PATH" || {
  echo 'Missing ASDF_INSTALL_PATH'
  exit 1
}

_get_arch() {
  local arch
  arch=$(uname -m)
  case $arch in
  # Note: Tool is only provided in AMD64 and ARM64 for the moment
  armv*) 
    arch="arm64"
    ;;
  x86_64)
    arch="amd64"
    ;;
  esac
  echo "$arch"
}

_get_platform() {
  uname | tr '[:upper:]' '[:lower:]'
}

install() {
  local -r version=$1
  local -r install_path=$2
  local -r tar_install_path="$install_path/kics-v$version.tgz"
  local -r bin_install_path="$install_path/bin"
  local -r platform="$(_get_platform)"
  local arch
  arch="$(_get_arch)"
  local -r download_url="https://github.com/Checkmarx/kics/releases/download/v${version}/kics_${version}_${platform}_${arch}.tar.gz"
  local -r bin_path="$bin_install_path/kics"

  mkdir -p "$bin_install_path"
  local tmp_dir
  tmp_dir="$(mktemp -d)"
  echo "Downloading kics from $download_url"

  curl -Ls "$download_url" -o "$tar_install_path"
  tar -xf "$tar_install_path" -C "$tmp_dir"

  cp -r "${tmp_dir}/kics" "$bin_path"
  rm -rf "$tar_install_path"
  rm -rf "$tmp_dir"
  chmod +x "$bin_path"
}

install "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
